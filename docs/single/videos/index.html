<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <link rel="icon" href="./favicon.ico" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Videos</title>
        <link href="../../common/css/video.js/video-js.min.css" rel="stylesheet" />
        <link href="../../common/css/video.js/vjs-theme-sea.css" rel="stylesheet" />
        <script src="../../common/js/vue.2.6.14.min.js"></script>
        <style>
            * {
                box-sizing: border-box;
            }

            html,
            body {
                margin: 0;
                width: 100vw;
                height: 100vh;
            }

            #app {
                width: 100vw;
                height: 100vh;
                display: flex;
                flex-direction: row;
                overflow: hidden;
            }

            aside {
                display: flex;
                flex-direction: column;
            }

            @media screen and (max-width: 1024px) {
                #app {
                    flex-direction: column-reverse;
                }

                aside {
                    flex: 1 0;
                    border-right: none;
                    overflow-y: auto;
                }

                .video {
                    flex: 0 1 20vh;
                }

                .video-js {
                    width: 100%;
                }

                #my-player_html5_api {
                    height: auto !important;
                }
            }

            @media screen and (min-width: 1024px) {
                aside {
                    width: 400px;
                    flex-shrink: 0;
                    border-right: #808080 solid 1px;
                    cursor: default;
                }

                .video {
                    flex: 1;
                }

                .video-js {
                    width: 100%;
                }
            }

            .category {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                height: 3rem;
                line-height: 3rem;
                border-bottom: #808080 solid 1px;
            }

            .category div {
                width: 4rem;
                text-align: center;
                flex: 1;
            }

            .category div.active {
                background-color: lightgray;
            }

            .list {
                display: block;
                flex: 1;
                list-style: none;
                padding-left: 0;
                overflow-y: auto;
                -ms-overflow-style: none;
                overflow: -moz-scrollbars-none;
            }

            .list::-webkit-scrollbar {
                width: 0 !important;
            }

            .list .item {
                padding: 0.5rem;
            }

            .list .item:hover {
                background-color: #f5f5f5;
            }

            .list .item.select {
                background-color: #efefef;
            }

            .list .item .title {
                min-height: 2rem;
                line-height: 2rem;
                padding-left: 1rem;
            }

            .list .item .title .status {
                font-weight: bold;
                min-height: 2rem;
                line-height: 2rem;
                font-size: 0.8rem;
                padding-right: 0.5rem;
                user-select: none;
            }

            .list .item .title.status-0 {
                color: #aaa;
            }

            .list .item .title.status-1 .status {
                color: #00a;
            }

            .list .item .title.status-2 .status {
                color: #0a0;
            }

            .list .item .title .info {
                display: inline-block;
                color: #74a193;
                font-size: 0.8rem;
                min-height: 2rem;
                line-height: 2rem;
            }

            @media screen and (min-width: 1024px) {
                .list .item .title {
                    word-break: keep-all;
                    white-space: nowrap;
                    width: fit-content;
                    min-width: 100%;
                }

                .list .item .title:hover {
                    animation: 5s wordsLoop linear infinite normal;
                }

                @-webkit-keyframes wordsLoop {
                    0%,
                    20% {
                        transform: translateX(0px);
                    }
                    45%,
                    55% {
                        transform: translateX(calc(-100% + 383px));
                    }
                    80%,
                    100% {
                        transform: translateX(0px);
                    }
                }
            }

            .list .item .part-wrapper {
                display: grid;
                justify-content: space-around;
                grid-template-columns: repeat(auto-fill, 3rem);
            }

            .list .item .part-wrapper .part {
                width: 3rem;
                display: inline-block;
                border-radius: 0.3rem;
                background-color: #f2fcfc;
                text-align: center;
                height: 1.5rem;
                line-height: 1.5rem;
                margin: 0.2rem;
                user-select: none;
                cursor: pointer;
            }

            .list .item .part-wrapper .part:hover {
                background-color: #cee3e3;
            }

            .no-data {
                color: gray;
                text-align: center;
                margin-top: 10rem;
            }
        </style>
    </head>
    <body>
        <div id="app">
            <aside>
                <div class="category">
                    <div v-for="(category, key) in categories" :class="currentCategory === key ? 'active' : ''" @click="currentCategory = key">
                        {{ category.title }}
                    </div>
                </div>
                <template v-for="(category, key) in categories" v-if="currentCategory === key">
                    <ul class="list" v-if="category.list.length > 0">
                        <template v-for="item in category.list" v-key="item.dir">
                            <li class="item" :class="item.show ? 'select' : ''" @click="showPart(item)">
                                <template v-if="item.num !== 0">
                                    <div class="title" :class="'status-'+item.status">
                                        <span class="status">{{ item.statusText }}</span><span class="name">{{ item.title }}</span>
                                        <span class="info" v-show="item.info">{{ item.info }}</span>
                                    </div>
                                    <div class="part-wrapper" v-show="item.show">
                                        <template v-for="num in item.num" v-key="num" v-if="num >= item.startNum">
                                            <div
                                                class="part"
                                                @click="play(key, item, getFileName(item.nameReg, num), $event)"
                                                @dblclick="copyUrl(key, item, getFileName(item.nameReg, num))"
                                            >
                                                {{ padNumber(num) }}
                                            </div>
                                        </template>
                                    </div>
                                </template>
                                <template v-else>
                                    <div v-if="item.status==='0'" class="title" :class="'status-'+item.status">
                                        <span class="status">{{ item.statusText }}</span>{{ item.title }}
                                    </div>
                                    <div
                                        v-else
                                        class="title"
                                        @click="play(key, item, item.nameReg, $event)"
                                        @dblclick="copyUrl(key, item, item.nameReg)"
                                    >
                                        <span class="status">{{ item.statusText }}</span>{{ item.title }}
                                    </div>
                                </template>
                            </li>
                        </template>
                    </ul>
                    <div class="no-data" v-else>no data</div>
                </template>
            </aside>
            <div class="video">
                <video v-if="current" id="my-player" class="video-js" :class="theme" controls preload="auto" data-setup="{}"></video>
            </div>
        </div>
    </body>
    <script src="../../common/js/video.min.js"></script>
    <script>
        let isWindows = navigator.appVersion.indexOf('Windows') > 0;
        let domain = 'http://e.onysakura.fun/videos/';
        let appDom = document.getElementById('app');
        let vm = new Vue({
            el: appDom,
            data() {
                return {
                    theme: 'vjs-theme-sea',
                    current: '',
                    lastUpdate: '',
                    currentCategory: 'Anime',
                    categories: {
                        Anime: {
                            title: 'Anime',
                            show: false,
                            list: []
                        },
                        Film: {
                            title: 'Film',
                            show: false,
                            list: []
                        },
                        Music: {
                            title: 'Music',
                            show: false,
                            list: []
                        }
                    }
                };
            },
            mounted() {
                let href = location.href;
                let index = href.indexOf('#');
                let hash;
                if (index > 0) {
                    hash = href.substr(index + 1);
                    console.log(hash);
                }
                if (hash && this.categories[hash]) {
                    this.currentCategory = hash;
                } else {
                    this.currentCategory = Object.keys(this.categories)[0];
                    window.location.hash = '#' + this.currentCategory;
                }
            },
            watch: {
                currentCategory(current, last) {
                    window.location.hash = '#' + this.currentCategory;
                }
            },
            methods: {
                play(category, item, part, e) {
                    e.stopPropagation();
                    let url = domain + encodeURIComponent(category) + '/' + encodeURIComponent(item.dir) + '/' + encodeURIComponent(part);
                    if (item.dir.indexOf('/') !== -1) {
                        url = url.replace(/%2F/g, '/');
                    }
                    if (this.current === part) {
                        return;
                    }
                    this.current = part;
                    setTimeout(() => {
                        let options = {};
                        if (item.srt) {
                            let suffix = url.substr(url.lastIndexOf('.'));
                            let srtSource = url.replace(new RegExp(suffix, 'g'), '.h5.vtt');
                            console.log(srtSource);
                            options = {
                                tracks: [
                                    {
                                        src: srtSource,
                                        kind: 'captions',
                                        srclang: 'zh',
                                        label: 'Chinese'
                                    }
                                ]
                            };
                        }
                        let isHandled = false;
                        vm.$nextTick(() => {
                            let player = videojs('my-player', options);
                            player.pause();
                            player.src(url);
                            player.load(url);
                            player.ready(() => {
                                let setHeight = setInterval(() => {
                                    let videoJs = document.getElementsByClassName('video-js')[0];
                                    if (videoJs) {
                                        clearInterval(setHeight);
                                        if (isWindows) {
                                            videoJs.style.height = '100%';
                                        } else {
                                            let offsetHeight = document.getElementById('my-player_html5_api').offsetHeight;
                                            videoJs.style.height = offsetHeight + 'px';
                                            document.getElementsByClassName('video')[0].style.height = offsetHeight + 'px';
                                        }
                                    }
                                }, 100);
                            });
                            player.on('error', function (e) {
                                if (!isHandled) {
                                    isHandled = true;
                                    console.log(e);
                                    console.log(player.error().message);
                                    try {
                                        let a = document.createElement('a');
                                        if (isWindows) {
                                            a.href = `vlc:${url}`;
                                        } else {
                                            a.href = `intent:${url}#Intent;package=com.mxtech.videoplayer.pro;S.title=${part};end`;
                                        }
                                        a.click();
                                    } catch (e) {
                                        this.writeClipboard(url);
                                        if (isWindows) {
                                            alert('拉起vlc播放器失败，已复制地址到剪切板');
                                        } else {
                                            alert('拉起mx播放器失败，已复制地址到剪切板');
                                        }
                                    }
                                }
                            });
                        }, 500);
                    });
                },
                copyUrl(category, item, part) {
                    let path = domain + encodeURIComponent(category) + '/' + encodeURIComponent(item.dir) + '/' + encodeURIComponent(part);
                    if (item.dir.indexOf('/') !== -1) {
                        path = path.replace(/%2F/g, '/');
                    }
                    console.log('path', path);
                    this.writeClipboard(path);
                    alert('已复制地址到剪切板');
                },
                showPart(item) {
                    let temp = item.show;
                    for (const key in this.categories) {
                        for (const item of this.categories[key].list) {
                            this.$set(item, 'show', false);
                        }
                    }
                    this.$set(item, 'show', !(temp || false));
                    console.log(item);
                },
                padNumber(num) {
                    let len = num.toString().length;
                    while (len < 2) {
                        num = '0' + num;
                        len++;
                    }
                    return num;
                },
                getFileName(nameReg, num) {
                    return nameReg.replace(/\${num}/g, this.padNumber(num));
                },
                writeClipboard(text) {
                    let input = document.createElement('input');
                    input.value = text;
                    input.style.display = 'block';
                    input.style.position = 'fixed';
                    input.style.top = '0';
                    input.style.marginTop = '-100px';
                    input.style.zIndex = '-1';
                    document.body.appendChild(input);
                    input.select();
                    input.setSelectionRange(0, input.value.length);
                    document.execCommand('Copy');
                    document.body.removeChild(input);
                }
            }
        });

        fetch('./data.csv?timestamp=' + new Date().getTime())
            .then((response) => response.text())
            .then((text) => {
                let sp = text.split('\n');
                for (let i = 1; i < sp.length; i++) {
                    if (sp[i].length > 0) {
                        let lineSplit = sp[i].split('|');
                        let category = lineSplit[0].trim();
                        let dir = lineSplit[1].trim();
                        let nameReg = lineSplit[2].trim();
                        let nums = lineSplit[3].trim();
                        let status = lineSplit[4].trim();
                        let subs = lineSplit[5].trim();
                        let info = lineSplit[6].trim();
                        let title = lineSplit[7].trim();
                        let startNum, endNum;
                        let statusText;
                        switch (status) {
                            case '0':
                                statusText = '暂无';
                                nums = '0';
                                break;
                            case '1':
                                statusText = '连载';
                                break;
                            case '2':
                                statusText = '完结';
                                break;
                            default:
                                statusText = '';
                                break;
                        }
                        if (nums.indexOf('-') > 0) {
                            startNum = nums.split('-')[0];
                            endNum = nums.split('-')[1];
                        } else {
                            startNum = '1';
                            endNum = nums;
                        }
                        let list = vm.categories[category].list;
                        list.push({
                            dir: dir,
                            title: title,
                            nameReg: nameReg,
                            srt: false,
                            status: status,
                            statusText: statusText,
                            info: subs,
                            startNum: parseInt(startNum),
                            num: parseInt(endNum)
                        });
                    }
                }
            });
        // document.body.addEventListener('touchmove', event => event.preventDefault(), false)
    </script>
</html>
